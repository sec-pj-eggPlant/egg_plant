<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Document</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
            crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/global.css"/>
    <link rel="stylesheet" href="../css/list.css"/>
    <link rel="stylesheet" href="../css/warehouse.css"/>
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
            crossorigin="anonymous"
    ></script>
</head>
<body>
<header id="header">
    <div class="container">
        <h1>
            <a href=""><img src="../images/logo.svg" alt=""/></a>
        </h1>
        <div class="search-box">
            <form action="">
                <input type="text" class="form-control" placeholder="search"/>
                <button class="btn" type="button">search</button>
            </form>
        </div>
        <a href="" id="profile">
            <span>김의진</span>
            <span class="img">
            <img src="../images/profile.jpg" alt=""/>
          </span>
        </a>
    </div>
</header>
<div class="container min-vh-100 list-wrap warehouse">
    <div class="sector tab-menu">
        <ul>
            <li>
                <button onclick="handleTabClick('A')">A</button>
            </li>
            <li>
                <button onclick="handleTabClick('B')">B</button>
            </li>
            <li>
                <button onclick="handleTabClick('C')">C</button>
            </li>

        </ul>
    </div>
    <div class="main-content row list-box">
        <div class="info-panel col-4 px-5">
            <div class="mb-4">
                <label for="sector-price" class="form-label fw-bold">개별 가격</label>
                <input type="text" class="form-control" id="sector-price" placeholder="price" readonly/>
            </div>

            <div class="mb-4">
                <label for="total-price" class="form-label fw-bold">총 가격</label>
                <input type="text" class="form-control" id="total-price" placeholder="price" readonly/>
            </div>

            <div class="mb-4">
                <label for="sector-area" class="form-label fw-bold">기본 면적</label>
                <input type="text" class="form-control" id="sector-area" placeholder="area" readonly/>
            </div>

            <div class="mb-4">
                <label for="total-price" class="form-label fw-bold">총 면적</label>
                <input type="text" class="form-control" id="total-area" placeholder="area" readonly/>
            </div>

            <div class="mb-4">
                <label for="" class="form-label fw-bold">기간</label>
                <div class="row">
                    <div class="col-md-6">
                        <input type="date" id="startDate" class="form-control" placeholder="YYYY-MM-DD"/>
                    </div>
                    <div class="col-md-6">
                        <input type="date" id="endDate" class="form-control" placeholder="YYYY-MM-DD"/>
                    </div>
                </div>
            </div>
            <div id="info-message" style="color:#ca2; margin-bottom:10px;">
                기간을 입력하시면 <b>자동으로 조회</b>되고 그 후 <b>신청 가능</b>합니다.
            </div>
            <div class="mb-4">
                <button class="btn btn-outline-secondary w-100" id="reset-button">초기화</button>
            </div>
            <div class="mb-4">
                <button class="apply-button btn btn-primary w-100 btn-lg" id="apply-button" onclick="apply()">신청</button>
            </div>


        </div>
        <div class="other-products col-8">
            <div class="items custom-check-wrap" id="tab-content"></div>
        </div>
    </div>
</div>
<footer>
    <div class="container">
        <div class="row pt-5">
            <div class="col-7">
                <ul class="d-flex gap-3">
                    <li><a href="">이용약관</a></li>
                    <li><a href="">개인정보처리방침</a></li>
                    <li><a href="">위치기반서비스</a></li>
                    <li><a href="">이용약관</a></li>
                    <li><a href="">이메일 무단수집거부</a></li>
                    <li><a href="">법적고지</a></li>
                    <li><a href="">사업자정보</a></li>
                </ul>
            </div>
            <div class="col-5">
                <p>
                    대표이사 : 이몽룡 | 개인정보보호책임자 : 임춘향 | 사업자등록번호 :
                    8282-82-828282
                </p>
                <p>
                    통신판매업종신고 : 제 2025-서울강남구-8282 | 대표이메일 :
                    gagi@gagi.store
                </p>
                <p>
                    copyright ⓒ 2021. 가지 : 가장가까운지역창고 Co., Ltd. All rights
                    reserved.
                </p>
            </div>
        </div>
    </div>
</footer>
<script>
    const sectorInfo = {};
    const selectedBoxes = new Set();

    function getActiveSector() {
        const active = document.querySelector('.sector ul li.on button');
        return active ? active.textContent.trim() : 'A';
    }

    function handleTabClick(type) {
        document.querySelectorAll('.sector ul li').forEach(li => li.classList.remove('on'));
        const button = document.querySelector(`.sector ul li button[onclick="handleTabClick('${type}')"]`);
        if (button) {
            button.parentElement.classList.add('on');
        }
        loadTab(type);
    }

    function toggleBox(el) {
        const id = el.dataset.warehouseUseId;
        const sector = el.dataset.sector;
        if (!id || !sector) return;
        if (el.classList.contains('disabled')) return;

        const key = `${sector}_${id}`;
        if (selectedBoxes.has(key)) {
            selectedBoxes.delete(key);
            el.classList.remove('selected');
        } else {
            selectedBoxes.add(key);
            el.classList.add('selected');
        }

        updateTotals();
    }

    function updateTotals() {
        let totalPrice = 0;
        let totalArea = 0;
        selectedBoxes.forEach(key => {
            const [sector] = key.split('_');
            const info = sectorInfo[sector];
            if (info) {
                totalPrice += info.pricePerDay;
                totalArea += info.area;
            }
        });

        document.getElementById('total-price').value = totalPrice.toLocaleString();
        document.getElementById('total-area').value = totalArea + ' m²';
    }

    function loadTab(type) {
        // 1. 탭 UI에서 'on' 클래스 처리
        document.querySelectorAll('.sector ul li').forEach(li => li.classList.remove('on'));
        // 버튼의 텍스트로 type 찾기 (A, B, C)
        const button = document.querySelector(`.sector ul li button[onclick="handleTabClick('${type}')"]`);
        if (button) {
            button.parentElement.classList.add('on');
        }

        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const tabContent = document.getElementById('tab-content');
        tabContent.innerHTML = '';
        tabContent.classList.remove('a-grid', 'b-grid', 'c-grid');

        fetch(`/warehouse/get-sector-pricing?sector=${type}`)
            .then(res => {
                if (!res.ok) throw new Error("가격 정보 로딩 실패");
                return res.json();
            })
            .then(pricing => {
                const price = pricing?.pricePerDay;
                const area = pricing?.area;
                if (price == null || area == null) {
                    console.error("Invalid pricing data:", pricing);
                    document.getElementById('sector-price').value = "";
                    document.getElementById('sector-area').value = "";
                    return;
                }
                sectorInfo[type] = {pricePerDay: price, area};
                document.getElementById('sector-price').value = price.toLocaleString();
                document.getElementById('sector-area').value = area + ' m²';
                updateTotals();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('sector-price').value = "";
                document.getElementById('sector-area').value = "";
            });

        fetch(`/warehouse/tab-content-json?type=${type}&startDate=${startDate}&endDate=${endDate}`)
            .then(res => res.json())
            .then(data => {
                let boxClass = '';
                if (type === 'A') {
                    tabContent.classList.add('a-grid');
                    boxClass = 'a-box';
                } else if (type === 'B') {
                    tabContent.classList.add('b-grid');
                    boxClass = 'b-box';
                } else if (type === 'C') {
                    tabContent.classList.add('c-grid');
                    boxClass = 'c-box';
                }

                data.forEach(box => {
                    const key = `${box.sector}_${box.id}`;

                    if (box.status === 'RENTED' && selectedBoxes.has(key)) {
                        selectedBoxes.delete(key);
                    }

                    const boxElement = document.createElement('div');
                    boxElement.classList.add('box', boxClass);
                    boxElement.textContent = box.boxNumber;
                    boxElement.dataset.warehouseUseId = box.id;
                    boxElement.dataset.sector = box.sector;

                    if (box.status === 'RENTED') {
                        boxElement.classList.add('disabled');
                    }

                    if (selectedBoxes.has(key)) {
                        boxElement.classList.add('selected');
                    }

                    boxElement.onclick = () => toggleBox(boxElement);
                    tabContent.appendChild(boxElement);
                });

                updateTotals();
            })
            .catch(err => console.error("탭 로딩 실패:", err));
    }

    function isValidDateRange(startDate, endDate) {
        if (!startDate || !endDate) return false;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const start = new Date(startDate);
        const end = new Date(endDate);
        if (start < today || start > end) return false;
        return true;
    }

    function showDateAlertIfInvalid(startDate, endDate) {
        if (!startDate || !endDate) return;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const start = new Date(startDate);
        const end = new Date(endDate);

        if (start < today) {
            alert("오늘 이전의 날짜를 고를 수 없습니다.");
            document.getElementById('startDate').value = "";
            document.getElementById('endDate').value = "";
            return;
        }
        if (start > end) {
            alert("종료일이 시작일보다 빠를 수 없습니다.");
            document.getElementById('startDate').value = "";
            document.getElementById('endDate').value = "";
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('startDate').addEventListener('input', () => {
            autoSearchAndAlert();
            updateApplyButtonState();
        });
        document.getElementById('endDate').addEventListener('input', () => {
            autoSearchAndAlert();
            updateApplyButtonState();
        });

        const searchButton = document.getElementById('search-button');
        if (searchButton) {
            searchButton.addEventListener('click', () => {
                autoSearchAndAlert(true);
            });
        }

        const resetButton = document.getElementById('reset-button');
        if (resetButton) {
            resetButton.addEventListener('click', () => {
                document.getElementById('startDate').value = "";
                document.getElementById('endDate').value = "";
                selectedBoxes.clear();
                loadTab(getActiveSector());
                updateTotals();
                updateApplyButtonState();
            });
        }

        const applyButton = document.getElementById('apply-button');
        if (applyButton) {
            applyButton.addEventListener('click', function() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if (!isValidDateRange(startDate, endDate)) {
                    showDateAlertIfInvalid(startDate, endDate);
                    return;
                }
                if (selectedBoxes.size === 0) {
                    alert("박스를 선택해주세요!");
                    return;
                }
                const boxIds = Array.from(selectedBoxes).map(k => k.split('_')[1]);
                const form = document.createElement('form');
                form.method = 'post';
                form.action = '/warehouse/payment';
                boxIds.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'boxIds';
                    input.value = id;
                    form.appendChild(input);
                });
                ['startDate', 'endDate'].forEach(name => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = name;
                    input.value = (name === 'startDate' ? startDate : endDate);
                    form.appendChild(input);
                });
                document.body.appendChild(form);
                form.submit();
            });
        }

        updateApplyButtonState();
        loadTab('A');
    });

    function autoSearchAndAlert(forceSearch = false) {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        if (!startDate || !endDate) return;
        if (isValidDateRange(startDate, endDate) || forceSearch) {
            loadTab(getActiveSector());
        } else {
            showDateAlertIfInvalid(startDate, endDate);
        }
    }

    function updateApplyButtonState() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const applyBtn = document.getElementById('apply-button');
        if (applyBtn) {
            applyBtn.disabled = !(isValidDateRange(startDate, endDate));
        }
    }
</script>

</body>
</html>
